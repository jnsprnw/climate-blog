name: Build and Deploy via FTP

on:
  # Trigger bei Push auf main branch
  push:
    branches:
      - main

  # Manueller Trigger Ã¼ber GitHub UI
  workflow_dispatch:

  # Trigger per POST-Request / API
  repository_dispatch:
    types: [deploy]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Code auschecken
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Bun installieren (da du bun.lockb hast)
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # 3. Dependencies installieren
      - name: Install dependencies
        run: bun install

      # 4. SvelteKit Build
      - name: Build SvelteKit app
        run: make fetch && bun run build
        env:
          CLOUDINARY_CLOUD: ${{ secrets.CLOUDINARY_CLOUD }}
          CLOUDINARY_KEY: ${{ secrets.CLOUDINARY_KEY }}
          CLOUDINARY_SECRET: ${{ secrets.CLOUDINARY_SECRET }}
          POCKETBASE_PW: ${{ secrets.POCKETBASE_PW }}
          POCKETBASE_URL: ${{ secrets.POCKETBASE_URL }}
          POCKETBASE_USER: ${{ secrets.POCKETBASE_USER }}
          PUBLIC_PAGE_URL: ${{ secrets.PUBLIC_PAGE_URL }}

      # 5. FTP Upload (optimized for speed)
      - name: Deploy to FTP Server
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host: ${{ secrets.FTP_SERVER }}
          user: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          localDir: ./build/
          remoteDir: ./
          options: '--verbose --only-newer --parallel=10 --use-cache --no-perms --exclude .git* --exclude node_modules/'
